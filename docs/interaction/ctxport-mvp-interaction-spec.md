# CtxPort MVP 交互设计规格文档

> 版本：v1.0 | 日期：2026-02-07
> 方法论：Alan Cooper Goal-Directed Design
> Primary Persona：Alex — The Multi-Tool Developer

---

## 1. 设计原则

### 1.1 基于 Persona 的设计锚点

Alex 是一位 28-38 岁的全栈开发者，日均在 4-5 个 AI 工具间切换。他的核心体验目标是**流畅、掌控、信任、不被打断**。以下设计原则直接从 Alex 的目标层次推导而来：

| 原则 | 来源 | 含义 |
|------|------|------|
| **一键即达（One-Click-Done）** | End Goal: 2 秒内完成打包 | 默认操作路径必须是：点击 → 完成。没有中间步骤、没有确认弹窗、没有格式选择 |
| **不打断原生体验（Invisible Integration）** | Experience Goal: 不被打断 | 注入的 UI 必须在视觉和交互上与 ChatGPT/Claude 原生风格融合，用户不应感到"这是一个第三方插件" |
| **渐进式披露（Progressive Disclosure）** | Cooper 原则 | 默认展示最简操作（复制按钮），高级功能（格式选项、批量模式）只在用户主动探索时出现 |
| **即时反馈（Immediate Feedback）** | Experience Goal: 掌控 | 每个操作必须有即时、明确的视觉反馈——用户永远不应怀疑"刚才点了有没有成功" |
| **零决策默认（Zero-Decision Default）** | End Goal: 不浪费时间选择 | 默认格式是完整 Markdown，默认操作是复制到剪贴板。所有默认值应该是 80% 场景下的最优选择 |
| **尊重用户的注意力预算** | Cooper 交互礼仪 | 不主动弹窗、不要求注册、不展示 onboarding 教程。用户安装后第一次看到复制按钮时，应该不需要任何说明就知道怎么用 |

### 1.2 性能约束

| 约束 | 阈值 | 说明 |
|------|------|------|
| 单次复制完成时间 | ≤ 3 秒 | 从点击到剪贴板写入完成 |
| 批量 10 个会话 | ≤ 10 秒 | 从点击"复制全部"到剪贴板写入完成 |
| UI 注入完成时间 | ≤ 500ms | 页面加载后注入按钮的延迟 |
| 反馈动画时长 | ≤ 2 秒 | 成功/失败提示的显示时长 |

---

## 2. 核心交互流程设计

### 流程 1：会话详情页一键复制

**场景**：Alex 正在 ChatGPT/Claude 的某个会话中阅读或对话，想把当前会话复制为 Markdown Context Bundle。

#### 2.1.1 按钮位置

**ChatGPT**：在会话页面顶部标题栏右侧区域，紧邻原生的"分享"和"..."菜单按钮的左边，注入一个 CtxPort 复制按钮。

```
┌─────────────────────────────────────────────────────────┐
│  💬 讨论 REST API 认证方案          [📋] [↗️] [···]    │
│                                      ↑                  │
│                              CtxPort 复制按钮            │
└─────────────────────────────────────────────────────────┘
```

**Claude**：同样在会话页面顶部标题栏右侧，紧邻原生操作按钮的左边。

**按钮设计**：
- 图标：使用剪贴板图标（clipboard icon），风格与平台原生图标保持一致（ChatGPT 使用 outlined style，Claude 使用其自身 icon style）
- 尺寸：与相邻原生按钮保持相同尺寸（通常 32x32px 或 36x36px）
- 颜色：继承平台的 icon 颜色变量（ChatGPT 的 `text-token-text-secondary`，Claude 的对应变量）
- Tooltip：hover 时显示 "Copy as Context Bundle (CtxPort)"，延迟 300ms 显示

#### 2.1.2 交互步骤

```
[空闲状态]
    │
    ├── 用户 hover 按钮
    │   └── 按钮 icon 颜色加深（opacity 从 0.6 → 1.0）
    │       Tooltip 显示 "Copy as Context Bundle"
    │
    ├── 用户点击按钮
    │   └── 进入 [加载状态]
    │       ├── 按钮 icon 替换为旋转 spinner（原地替换，不跳动）
    │       ├── 解析当前页面 DOM，提取会话内容
    │       ├── 转换为 Markdown Context Bundle
    │       ├── 写入剪贴板（navigator.clipboard.writeText）
    │       │
    │       ├── 成功 → 进入 [成功状态]
    │       │   ├── 按钮 icon 替换为 checkmark（✓），颜色变为绿色
    │       │   ├── 按钮旁显示简短 toast："已复制 24 条消息"
    │       │   ├── 1.5 秒后自动回到 [空闲状态]
    │       │   └── toast 淡出消失
    │       │
    │       └── 失败 → 进入 [失败状态]
    │           ├── 按钮 icon 替换为 warning（⚠），颜色变为橙色
    │           ├── 按钮旁显示 toast："复制失败：会话内容为空"
    │           ├── 3 秒后自动回到 [空闲状态]
    │           └── toast 淡出消失
    │
    └── 用户右键点击按钮（高级操作入口）
        └── 显示小型上下文菜单：
            ├── "复制完整会话"（默认，带 ✓ 标记）
            ├── "仅复制用户消息"
            ├── "仅复制代码块"
            ├── "复制精简版"
            └── ─────────────
                "关于 CtxPort"
```

#### 2.1.3 设计决策说明

**为什么用右键菜单而非下拉菜单？**
- 左键点击是最高频操作，必须零摩擦：点一下就复制完整会话
- 格式选项是低频操作（预计 <25% 用户会使用），放在右键菜单中符合渐进式披露原则
- 右键菜单是开发者熟悉的交互模式（IDE、Terminal 中大量使用）
- 避免了在主操作路径上增加决策步骤

**为什么不用 Popup 弹窗？**
- 弹窗需要两次点击（打开 → 点复制），违反"一键即达"原则
- 弹窗遮挡页面内容，打断阅读流
- 弹窗需要关闭操作，增加认知负担

---

### 流程 2：左侧列表不打开会话就复制（杀手级功能）

**场景**：Alex 在 ChatGPT/Claude 的左侧会话列表中看到之前的会话标题，想快速复制其内容，不想打开它（因为打开一个长会话需要 3-10 秒加载）。

#### 2.2.1 按钮位置和行为

**ChatGPT 左侧列表注入**：

```
┌──────────────────────────────┐
│  🔍 Search chats...          │
├──────────────────────────────┤
│  Today                       │
│  ┌──────────────────────┐    │
│  │ 讨论 REST API 认证    [📋]│  ← hover 时才显示复制图标
│  └──────────────────────┘    │
│  ┌──────────────────────┐    │
│  │ React 状态管理重构     [📋]│
│  └──────────────────────┘    │
│  ┌──────────────────────┐    │
│  │ Docker 部署配置       [📋]│
│  └──────────────────────┘    │
│                              │
│  Yesterday                   │
│  ┌──────────────────────┐    │
│  │ GraphQL Schema 设计   [📋]│
│  └──────────────────────┘    │
└──────────────────────────────┘
```

**复制图标显示逻辑**：
- **默认隐藏**：列表项在非 hover 状态下不显示复制图标，保持列表的干净和原生感
- **hover 显示**：鼠标移入某个会话项时，在该项的右侧（原生"..."菜单按钮的左边）显示复制图标
- **图标样式**：与流程 1 相同的剪贴板图标，尺寸略小（24x24px），颜色继承平台主题

#### 2.2.2 交互步骤

```
[列表项默认状态]
    │
    ├── 鼠标 hover 进入列表项
    │   └── 列表项右侧 fade-in 显示复制图标（动画 150ms）
    │       图标初始 opacity 0.5
    │
    ├── 鼠标 hover 到复制图标上
    │   └── 图标 opacity → 1.0
    │       Tooltip："复制此会话（不用打开）"
    │
    ├── 点击复制图标
    │   └── 进入 [数据获取状态]
    │       │
    │       ├── 图标替换为小型旋转 spinner
    │       ├── 通过 API 或 DOM 预加载获取该会话完整内容
    │       │   （不改变当前页面视图，不导航到该会话）
    │       │
    │       ├── 成功 → [成功状态]
    │       │   ├── 图标替换为 ✓，颜色变绿
    │       │   ├── 列表项短暂闪烁绿色背景（200ms fade）
    │       │   ├── 在列表项下方或图标旁显示小 toast："已复制 18 条消息"
    │       │   └── 1.5 秒后恢复默认
    │       │
    │       └── 失败 → [失败状态]
    │           ├── 图标替换为 ⚠，颜色变橙
    │           ├── 显示 toast："获取失败，请打开会话后重试"
    │           └── 3 秒后恢复默认
    │
    └── 鼠标离开列表项
        └── 复制图标 fade-out 消失（150ms）
            如果正在加载中，图标保持显示直到操作完成
```

#### 2.2.3 数据获取策略

这是技术上最关键的设计决策——如何在不导航到会话页面的情况下获取会话内容。

**策略优先级**：

1. **优先：平台 API 直接获取**
   - ChatGPT：通过 `https://chatgpt.com/backend-api/conversation/{id}` 获取会话 JSON（使用用户现有的 session cookie）
   - Claude：通过 `https://claude.ai/api/organizations/{org_id}/chat_conversations/{id}` 获取
   - 优势：速度最快（通常 <1 秒），不影响当前页面状态
   - 风险：API 端点可能变化，需要维护

2. **降级：后台 Tab 加载**
   - 如果 API 获取失败，在后台创建不可见的 tab 加载该会话
   - 从 tab 的 DOM 中提取内容
   - 提取完成后自动关闭后台 tab
   - 用户无感知（tab 创建和关闭不影响当前焦点）

3. **最终降级：提示用户打开**
   - 如果以上方式都失败，toast 提示"请打开此会话后使用页面内复制按钮"
   - 不强制跳转，尊重用户当前工作流

#### 2.2.4 关键设计决策

**为什么 hover 才显示，而非始终显示？**
- 始终显示会让列表看起来"被第三方工具污染了"，违反"不污染原生 UI"原则
- ChatGPT/Claude 自身的列表项操作（重命名、删除、归档）也是 hover 才显示
- 保持与原生交互模式一致

**为什么不使用 Popup 或 Sidebar？**
- Alex 的目标是"快速复制"，不是"浏览和管理"
- 额外的 UI 面板增加了视觉噪音和认知负担
- 在原位操作（in-place action）比打开新面板更符合"不打断"原则

**与原生菜单的共存**：
- ChatGPT 和 Claude 的列表项 hover 时已有"..."（更多操作）按钮
- CtxPort 的复制图标放置在"..."按钮的左边，两者并列
- 点击区域不重叠，避免误操作

---

### 流程 3：批量多选 + 打包复制

**场景**：Alex 想把某个项目相关的 5 个会话合并为一个 Context Bundle，一次性粘贴到 Cursor 或 Claude Code 中。

#### 2.3.1 进入多选模式

**触发方式（三种，并行支持）**：

| 方式 | 操作 | 说明 |
|------|------|------|
| **快捷键** | `Cmd/Ctrl + Shift + E` | 开发者最快的方式。E = Export |
| **长按图标** | 长按任意列表项的复制图标 500ms | 从单次复制自然过渡到批量模式 |
| **扩展 Popup 按钮** | 点击 Chrome 工具栏 CtxPort 图标 → "批量选择模式" | 兜底入口，对键盘快捷键不敏感的用户 |

#### 2.3.2 多选模式下的列表状态

```
┌──────────────────────────────────┐
│  CtxPort 批量选择模式              │  ← 顶部浮动条
│  已选 3 个会话  [复制全部] [取消]  │
├──────────────────────────────────┤
│  Today                           │
│  ┌────────────────────────────┐  │
│  │ [✓] 讨论 REST API 认证     │  │  ← 选中态：左侧 checkbox 勾选，
│  │                            │  │     行背景色加深
│  └────────────────────────────┘  │
│  ┌────────────────────────────┐  │
│  │ [ ] React 状态管理重构      │  │  ← 未选中：左侧 checkbox 空
│  └────────────────────────────┘  │
│  ┌────────────────────────────┐  │
│  │ [✓] Docker 部署配置        │  │
│  └────────────────────────────┘  │
│                                  │
│  Yesterday                       │
│  ┌────────────────────────────┐  │
│  │ [✓] GraphQL Schema 设计    │  │
│  └────────────────────────────┘  │
│  ┌────────────────────────────┐  │
│  │ [ ] 调试 CORS 问题         │  │
│  └────────────────────────────┘  │
└──────────────────────────────────┘
```

**列表状态变化**：
- 每个列表项左侧出现 checkbox（替换原有的会话图标位置，或在其左侧注入）
- 点击列表项本身 = 切换选中状态（整行可点击），不再是打开会话
- 选中项的背景色加深（使用平台的 accent 色 + 低 opacity，如 `rgba(accent, 0.1)`）
- 未选中项保持原样

**顶部浮动操作栏**：
- 位于左侧列表区域的顶部（搜索栏下方），固定定位
- 显示内容：`已选 N 个会话` + `[复制全部]` 按钮 + `[取消]` 按钮
- `[复制全部]` 按钮使用平台的 primary 色，视觉突出
- `[取消]` 按钮使用次要样式（ghost button）

#### 2.3.3 批量选择的交互细节

**选择操作**：
- 点击 checkbox 或列表项行 → 切换单个会话的选中/取消
- `Cmd/Ctrl + A` → 全选当前可见列表（带确认 toast："已全选 N 个会话"）
- `Shift + 点击` → 范围选择（与第一个选中项之间的所有项）
- 选中数量实时更新到顶部浮动栏

**退出多选模式**：
- 点击 `[取消]` 按钮
- 按 `Esc` 键
- 完成复制后自动退出
- 点击左侧列表区域外（进入会话区域）

#### 2.3.4 批量复制流程

```
[用户点击"复制全部"]
    │
    ├── 进入 [批量加载状态]
    │   ├── "复制全部" 按钮变为 "正在复制... (0/5)"
    │   ├── 每个选中项的 checkbox 依次变为 spinner → ✓
    │   │   （可视化进度，用户知道正在处理哪一个）
    │   ├── 依次获取每个会话的内容
    │   ├── 将所有会话合并为单一 Context Bundle
    │   │
    │   │   合并格式示例：
    │   │   ─────────────────────────────
    │   │   <!-- CtxPort Context Bundle (3 conversations) -->
    │   │   <!-- Generated: 2026-02-07T14:30:00Z -->
    │   │
    │   │   ---
    │   │   # [1/3] 讨论 REST API 认证方案
    │   │   <!-- Source: ChatGPT | Messages: 24 -->
    │   │   ## User
    │   │   ...
    │   │   ## Assistant
    │   │   ...
    │   │
    │   │   ---
    │   │   # [2/3] Docker 部署配置
    │   │   <!-- Source: Claude | Messages: 12 -->
    │   │   ...
    │   │
    │   │   ---
    │   │   # [3/3] GraphQL Schema 设计
    │   │   ...
    │   │   ─────────────────────────────
    │   │
    │   ├── 成功 → [批量成功状态]
    │   │   ├── 顶部浮动栏变为绿色背景
    │   │   ├── 显示："已复制 3 个会话（共 54 条消息）"
    │   │   ├── 所有选中项的 checkbox 显示 ✓
    │   │   ├── 2 秒后自动退出多选模式
    │   │   └── 列表恢复正常状态
    │   │
    │   └── 部分失败 → [部分成功状态]
    │       ├── 顶部浮动栏变为橙色背景
    │       ├── 显示："已复制 2/3 个会话（1 个失败）"
    │       ├── 失败项的 checkbox 显示 ⚠
    │       ├── 用户可选择"仅复制成功的"或"重试失败的"
    │       └── 不自动退出，等待用户操作
```

#### 2.3.5 设计决策说明

**为什么不用拖拽选择？**
- 拖拽需要精确的鼠标操作，对长列表不友好
- 拖拽与列表的原生滚动行为冲突
- Checkbox 模式是最通用、最无歧义的多选交互

**为什么用 `Cmd/Ctrl + Shift + E` 而非其他快捷键？**
- `E` = Export，语义直觉
- `Cmd/Ctrl + Shift` 前缀表示"扩展功能"，避开了浏览器和平台自身的快捷键
- ChatGPT 和 Claude 均未使用此快捷键组合
- 作为备选，如果存在冲突可在扩展设置中自定义

**合并顺序**：
- 默认按选择顺序排列（用户点击的顺序）
- 在合并 Bundle 的元数据注释中标注序号 `[1/N]`，方便用户在目标工具中理解结构

---

### 流程 4：复制格式选项

**场景**：Alex 在大多数情况下使用默认的完整 Markdown 格式，但偶尔需要仅复制自己的提问（用作 prompt 模板）或仅复制 AI 生成的代码块（直接粘贴到 IDE）。

#### 2.4.1 格式选项定义

| 格式 | 标签 | 说明 | 典型场景 |
|------|------|------|---------|
| **完整会话** | Full | 所有角色的所有消息，完整 Markdown | 跨工具上下文迁移（默认） |
| **仅用户消息** | User Only | 只保留 Human/User 角色的消息 | 提取自己的 prompt 作为模板复用 |
| **仅代码块** | Code Only | 只提取会话中的 ` ``` ` 代码块 | 直接粘贴到 IDE |
| **精简版** | Compact | 全部消息但移除代码块内的注释和空行，压缩空白 | Token 预算紧张时 |

#### 2.4.2 格式选项的呈现方式

**核心原则：不能挡路（Don't Block the Happy Path）**

格式选项通过两个入口暴露，均为非默认路径：

**入口 1：会话详情页复制按钮的右键菜单**（流程 1 中已描述）

```
右键点击复制按钮 →
┌─────────────────────────────┐
│  ✓ 复制完整会话    Cmd+C     │  ← 默认选中
│    仅用户消息      Cmd+Alt+U │
│    仅代码块        Cmd+Alt+K │
│    精简版          Cmd+Alt+M │
│  ─────────────────────────── │
│    关于 CtxPort              │
└─────────────────────────────┘
```

**入口 2：批量模式顶部栏的下拉选项**

```
┌──────────────────────────────────────────┐
│  已选 3 个会话  [▾ 完整会话] [复制全部]   │
│                  ↑                        │
│          点击展开格式选择下拉              │
└──────────────────────────────────────────┘
```

下拉选择器仅在多选模式中出现，不影响单次复制的一键体验。

**入口 3：左侧列表复制图标的右键菜单**

与入口 1 相同的菜单结构，在列表项的复制图标上右键触发。

#### 2.4.3 格式选项的记忆

- 最近使用的格式会被记住（存储在 `chrome.storage.local`）
- 但**每次新会话默认仍为"完整会话"**——不让偶尔一次的格式选择改变默认行为
- 在右键菜单中，最近使用过的非默认格式会有一个"最近使用"标记

#### 2.4.4 格式选项的快捷键

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| `Cmd/Ctrl + Shift + C` | 复制完整会话 | 与"一键复制"相同效果 |
| `Cmd/Ctrl + Shift + U` | 仅用户消息 | U = User |
| `Cmd/Ctrl + Shift + K` | 仅代码块 | K = Kode / Code（避免与 Cmd+C 冲突） |
| `Cmd/Ctrl + Shift + M` | 精简版 | M = Minimal |

快捷键仅在 ChatGPT/Claude 页面激活时生效，不影响其他网站。

---

### 流程 5：复制结果反馈

**设计哲学**：反馈应该是**轻量、即时、有信息量**的，不应中断用户的下一步操作。Alex 复制完会话后的下一步是 `Cmd+Tab` 切换到另一个工具然后 `Cmd+V` 粘贴——反馈不应阻塞这个流程。

#### 2.5.1 成功反馈

**视觉反馈（三层叠加）**：

```
层 1：按钮状态变化
      复制图标 → ✓（checkmark），颜色变绿
      持续 1.5 秒后恢复

层 2：内联 Toast
      在按钮旁边（会话详情页）或列表项下方（列表复制）
      出现一行小字："已复制 24 条消息 · ~8.2K tokens"
      背景色：半透明绿色
      fade-in 200ms → 停留 1.5s → fade-out 300ms

层 3（仅批量模式）：顶部浮动栏更新
      "已复制 5 个会话（共 112 条消息 · ~38K tokens）"
      绿色背景 flash → 2 秒后恢复
```

**Toast 内容格式**：
- 单次复制：`已复制 {N} 条消息 · ~{tokens}K tokens`
- 批量复制：`已复制 {N} 个会话（共 {M} 条消息 · ~{tokens}K tokens）`
- Token 估算使用 ~4 chars/token 的粗略近似，不需要精确（用 `~` 前缀标明是近似值）

**为什么显示 token 估算？**
- Alex 关心的核心问题之一是"这些内容粘贴过去会不会超出目标工具的 context window"
- 粗略的 token 数给用户一个直觉判断，不需要精确
- 这也是产品教育的一部分——帮助用户建立"上下文大小"的概念

#### 2.5.2 失败反馈

**失败类型和对应反馈**：

| 失败类型 | 原因 | 反馈 | 恢复建议 |
|---------|------|------|---------|
| **内容为空** | 会话刚创建无内容，或 DOM 解析失败 | "复制失败：无法读取会话内容" | "请刷新页面后重试" |
| **剪贴板写入失败** | 浏览器权限限制或焦点丢失 | "复制失败：无法写入剪贴板" | "请点击页面任意位置后重试" |
| **网络获取失败** | 列表复制时 API 请求失败 | "获取失败：网络错误" | "请打开此会话后使用页面内复制" |
| **部分失败** | 批量复制中某些会话失败 | "已复制 3/5 个会话（2 个失败）" | "[仅复制成功的] [重试失败的]" |
| **会话加载中** | 用户在会话还在加载时就点了复制 | "请等待会话加载完成" | 按钮暂时禁用，加载完成后自动启用 |

**失败 Toast 样式**：
- 背景色：半透明橙色（不用红色——失败不是灾难性的，只是需要重试）
- 持续时间：3 秒（比成功更长，给用户阅读时间）
- 包含简短的恢复建议文案

#### 2.5.3 复制内容预览（可选功能，非强制）

**设计定位**：预览是一个"可发现但不推送"的功能，给想确认复制内容的用户一个快速查看方式。

**触发方式**：复制成功后的 toast 中带一个不起眼的"[预览]"链接

```
┌─────────────────────────────────────────────┐
│ ✓ 已复制 24 条消息 · ~8.2K tokens  [预览]   │
└─────────────────────────────────────────────┘
```

**预览交互**：
- 点击"[预览]" → 在页面右下角弹出一个小型浮动面板（最大 400x300px）
- 面板显示 Markdown 原文的前 20 行 + "..."省略标记
- 面板可拖动、可关闭（点击 X 或点击面板外）
- 不是模态弹窗——不阻塞页面交互

**为什么不默认显示预览？**
- 大多数情况下用户信任复制结果，预览增加视觉噪音
- 强制预览会破坏"复制 → 切换 → 粘贴"的流畅节奏
- 有需要的用户可以在目标工具中粘贴后自己查看

---

## 3. UI 注入点详细说明

### 3.1 ChatGPT（chat.openai.com / chatgpt.com）

| 注入点 | DOM 位置 | 注入元素 | 触发条件 |
|--------|---------|---------|---------|
| **会话详情页复制按钮** | 会话顶部标题栏右侧操作按钮区 | 剪贴板图标按钮 | 页面加载且会话内容存在 |
| **左侧列表复制图标** | 每个会话列表项右侧 | hover 时显示的剪贴板小图标 | 鼠标 hover 到列表项 |
| **批量模式浮动栏** | 左侧列表区域顶部（搜索栏下方） | 计数 + 操作按钮 | 进入多选模式 |
| **批量模式 Checkbox** | 每个列表项左侧 | Checkbox 控件 | 进入多选模式 |
| **Toast 通知** | 页面右下角或按钮相邻区域 | 浮动文本提示 | 复制操作完成 |

**ChatGPT DOM 适配注意事项**：
- ChatGPT 使用 Next.js + React，DOM 结构可能因 A/B 测试而有变体
- 使用多层 CSS selector fallback（至少 3 种选择策略）
- 会话列表使用虚拟滚动（Virtualized List），需要在滚动时动态注入图标
- 监听 DOM 变化（MutationObserver）以处理动态加载和路由切换

### 3.2 Claude（claude.ai）

| 注入点 | DOM 位置 | 注入元素 | 触发条件 |
|--------|---------|---------|---------|
| **会话详情页复制按钮** | 会话顶部操作区域 | 剪贴板图标按钮 | 页面加载且会话内容存在 |
| **左侧列表复制图标** | 每个会话列表项右侧 | hover 时显示的剪贴板小图标 | 鼠标 hover 到列表项 |
| **批量模式浮动栏** | 左侧列表区域顶部 | 计数 + 操作按钮 | 进入多选模式 |
| **批量模式 Checkbox** | 每个列表项左侧 | Checkbox 控件 | 进入多选模式 |
| **Toast 通知** | 页面右下角或按钮相邻区域 | 浮动文本提示 | 复制操作完成 |

**Claude DOM 适配注意事项**：
- Claude 使用 React + Tailwind CSS，CSS 变量系统与 ChatGPT 不同
- 侧边栏可能被折叠，需要在展开时动态注入
- Claude 的 Project 功能会在列表中引入不同的项目类型，只对"会话"类型注入
- Claude 的"Starred"和"Recent"分组需要分别处理

### 3.3 CSS 变量适配策略

CtxPort 注入的所有 UI 元素不使用硬编码颜色，而是继承平台的 CSS 变量：

```css
/* 通用策略：优先使用平台变量，兜底使用自定义值 */
.ctxport-btn {
  color: var(--text-secondary, var(--ctxport-text-secondary, #666));
  background: var(--surface-primary, var(--ctxport-surface, transparent));
}

.ctxport-btn:hover {
  color: var(--text-primary, var(--ctxport-text-primary, #333));
}

.ctxport-success {
  color: var(--green-500, var(--ctxport-success, #22c55e));
}

.ctxport-warning {
  color: var(--orange-500, var(--ctxport-warning, #f97316));
}
```

**暗色/亮色模式适配**：
- 检测平台的 `prefers-color-scheme` 和平台自身的主题设置（如 ChatGPT 的暗色模式 class）
- 所有颜色通过 CSS 变量控制，暗色模式自动切换
- 如果平台变量不可用，使用 `matchMedia('(prefers-color-scheme: dark)')` 作为降级

---

## 4. 状态机描述

### 4.1 单次复制状态机

```
                    ┌──────────┐
                    │   IDLE   │◄─────────────────────┐
                    └────┬─────┘                      │
                         │                            │
                    点击复制按钮                   1.5s 自动恢复
                         │                            │
                    ┌────▼─────┐                      │
                    │ LOADING  │                      │
                    └────┬─────┘                      │
                         │                            │
              ┌──────────┼──────────┐                 │
              │          │          │                  │
         解析成功    剪贴板写入失败   DOM 解析失败      │
              │          │          │                  │
         ┌────▼─────┐ ┌─▼────────┐ ┌▼──────────┐     │
         │ SUCCESS  │ │ CLIP_ERR │ │ PARSE_ERR │     │
         └────┬─────┘ └────┬─────┘ └─────┬─────┘     │
              │            │              │           │
              └────────────┴──────────────┴───────────┘
```

| 状态 | 按钮图标 | 按钮颜色 | Toast | 持续时间 |
|------|---------|---------|-------|---------|
| IDLE | 剪贴板 | 平台默认色 | 无 | 持续 |
| LOADING | 旋转 spinner | 平台默认色 | 无 | 直到操作完成 |
| SUCCESS | ✓ checkmark | 绿色 | "已复制 N 条消息 · ~XK tokens" | 1.5 秒 |
| CLIP_ERR | ⚠ warning | 橙色 | "无法写入剪贴板" | 3 秒 |
| PARSE_ERR | ⚠ warning | 橙色 | "无法读取会话内容" | 3 秒 |

### 4.2 列表复制状态机

```
                ┌─────────┐
                │ HIDDEN  │◄──────── 鼠标离开列表项
                └────┬────┘          （且非加载中）
                     │
                鼠标 hover 进入
                     │
                ┌────▼────┐
                │ VISIBLE │◄─────────────────────┐
                └────┬────┘                      │
                     │                      1.5s 自动恢复
                点击复制图标                      │
                     │                            │
                ┌────▼─────┐                      │
                │ FETCHING │  获取会话内容          │
                └────┬─────┘                      │
                     │                            │
              ┌──────┼──────┐                     │
              │             │                     │
           获取成功       获取失败                  │
              │             │                     │
         ┌────▼─────┐  ┌───▼──────┐              │
         │ SUCCESS  │  │ FETCH_ERR│              │
         └────┬─────┘  └────┬─────┘              │
              │             │                     │
              └─────────────┴─────────────────────┘
```

### 4.3 批量模式状态机

```
              ┌──────────┐
              │  NORMAL  │  （正常列表模式）
              └────┬─────┘
                   │
        快捷键 / 长按 / Popup 按钮
                   │
              ┌────▼──────┐
              │ SELECTING │  （多选模式）
              └────┬──────┘
                   │
              点击"复制全部"
                   │
              ┌────▼──────┐
              │  COPYING  │  （批量复制中）
              └────┬──────┘
                   │
           ┌───────┼───────┐
           │               │
        全部成功         部分失败
           │               │
    ┌──────▼─────┐  ┌──────▼───────┐
    │ ALL_SUCCESS │  │ PARTIAL_FAIL │
    └──────┬─────┘  └──────┬───────┘
           │               │
      2s 自动退出     等待用户操作
           │               │
           └───────┬───────┘
                   │
              ┌────▼─────┐
              │  NORMAL  │
              └──────────┘
```

| 状态 | 浮动栏内容 | 列表项状态 | 退出方式 |
|------|-----------|-----------|---------|
| NORMAL | 无 | 正常显示 | — |
| SELECTING | "已选 N 个会话 [复制全部] [取消]" | 显示 checkbox | Esc / 点击取消 / 点击列表外 |
| COPYING | "正在复制... (2/5)" | 逐个 spinner → ✓ | 自动结束 |
| ALL_SUCCESS | "已复制 5 个会话" （绿色背景） | 全部 ✓ | 2 秒后自动退出 |
| PARTIAL_FAIL | "已复制 3/5（2 个失败）[仅成功的] [重试]" | ✓ 或 ⚠ | 用户点击操作 |

---

## 5. 快捷键设计

### 5.1 快捷键总表

| 快捷键 | 功能 | 作用域 | 助记 |
|--------|------|--------|------|
| `Cmd/Ctrl + Shift + C` | 复制当前会话（完整格式） | 会话详情页 | C = Copy |
| `Cmd/Ctrl + Shift + U` | 复制当前会话（仅用户消息） | 会话详情页 | U = User |
| `Cmd/Ctrl + Shift + K` | 复制当前会话（仅代码块） | 会话详情页 | K = Kode |
| `Cmd/Ctrl + Shift + M` | 复制当前会话（精简版） | 会话详情页 | M = Minimal |
| `Cmd/Ctrl + Shift + E` | 进入/退出批量选择模式 | 会话列表可见时 | E = Export |
| `Cmd/Ctrl + A` | 全选（多选模式下） | 多选模式激活时 | A = All |
| `Escape` | 退出多选模式 | 多选模式激活时 | — |
| `Enter` | 执行复制（多选模式下） | 多选模式激活时 | — |

### 5.2 冲突规避

- 所有 CtxPort 快捷键使用 `Cmd/Ctrl + Shift` 前缀，与浏览器原生快捷键（`Cmd/Ctrl` 单独）和平台快捷键（通常无修饰键或仅 `Cmd/Ctrl`）隔离
- `Cmd/Ctrl + Shift + C` 在 Chrome 中默认打开 DevTools Console——CtxPort 仅在 ChatGPT/Claude 域名下覆盖此快捷键。如果用户需要在这些页面打开 DevTools，可以通过 Chrome 菜单打开或使用 `F12`
- 如果检测到快捷键冲突，CtxPort 会在首次安装时提示，并允许用户在扩展设置中自定义所有快捷键
- 可在 Chrome 的 `chrome://extensions/shortcuts` 中配置扩展快捷键

### 5.3 快捷键可发现性

- 右键菜单中每个选项旁显示对应快捷键
- 首次使用时，成功 toast 中附带快捷键提示："下次试试 Cmd+Shift+C 更快"（仅显示一次）
- 扩展 Popup 页面底部显示快捷键速查表

---

## 6. 响应式和适配考虑

### 6.1 侧边栏折叠/展开

- 当 ChatGPT/Claude 的左侧侧边栏折叠时，列表复制图标和批量模式不可用（因为列表不可见）
- 侧边栏展开时，使用 MutationObserver 检测并动态注入 UI 元素
- 侧边栏折叠/展开的动画过程中不注入，等动画完成后再注入

### 6.2 窗口尺寸

- **大屏（>1200px）**：标准布局，所有注入点正常显示
- **中屏（768-1200px）**：ChatGPT/Claude 可能自动折叠侧边栏，按照折叠规则处理
- **小屏（<768px）**：ChatGPT/Claude 通常使用移动端布局。MVP 不专门适配移动端（Chrome 扩展在移动端支持有限），但确保注入元素不破坏原生布局

### 6.3 平台更新应对

- **DOM 变更检测**：Content Script 在注入前验证目标 DOM 节点是否存在，不存在时静默降级（不报错、不崩溃）
- **多层选择器策略**：
  1. 首选：基于 `data-testid` 属性选择（最稳定）
  2. 次选：基于语义化 class 名选择
  3. 降级：基于 DOM 层级结构选择
- **自动报告**：DOM 匹配失败时，在 console 输出 warning（不弹窗打扰用户），方便调试
- **热更新**：非核心 UI 注入逻辑通过远程配置更新 selector，无需发布新版本

### 6.4 暗色/亮色模式详细适配

**ChatGPT**：
- 检测 `<html>` 标签上的 `class` 是否包含 `dark`
- 监听 class 变化以实时切换主题
- 暗色模式下：图标使用亮色（继承 `--text-secondary`），toast 背景使用暗色半透明

**Claude**：
- 检测 Claude 的主题设置（可能存储在 `localStorage` 或通过 CSS 变量体现）
- 与 ChatGPT 相同的监听和切换策略
- Claude 的设计语言偏向更圆润的 UI 元素，注入元素的 `border-radius` 需要匹配

---

## 7. 交互陷阱和规避策略

### 7.1 陷阱：用户不知道扩展已安装

**问题**：安装扩展后，用户可能不注意到页面上多了一个小按钮。

**规避**：
- 首次安装后打开 ChatGPT/Claude 时，复制按钮有一次性的微动画（轻微脉冲 3 次），吸引注意力
- 首次点击复制后，toast 中显示"CtxPort 已就绪"的一次性欢迎消息
- 不使用全屏 onboarding、不使用遮罩层引导——开发者讨厌这些

### 7.2 陷阱：复制按钮与原生按钮混淆

**问题**：用户可能把 CtxPort 的复制按钮误认为是平台原生功能。

**规避**：
- Tooltip 明确标注"(CtxPort)"后缀
- 复制按钮使用与原生按钮略有区分但风格一致的图标（例如剪贴板图标上带一个微小的外部导出箭头）
- 成功 toast 中显示"CtxPort"品牌名（轻量级品牌曝光）

### 7.3 陷阱：长会话的复制时间超过 3 秒

**问题**：包含 100+ 条消息的长会话，DOM 解析可能超过 3 秒。

**规避**：
- 使用增量解析：优先解析前 N 条和后 N 条消息，中间部分异步补充
- 解析过程中 spinner 持续旋转——用户能看到"正在处理"
- 如果超过 5 秒，toast 更新为"正在处理长会话...已解析 N/M 条消息"
- 设置最大超时（30 秒），超时后提供"仅复制已解析部分"的选项

### 7.4 陷阱：列表复制时用户点击了会话标题

**问题**：复制图标和会话标题在同一行，用户可能误点标题（导致打开会话）而非复制图标。

**规避**：
- 复制图标有足够大的点击区域（至少 32x32px 可点击区域，即使视觉图标只有 20px）
- 复制图标与列表项文字之间有至少 8px 的间距
- 在多选模式下，点击列表项整行是切换选中状态，不是打开会话——行为语义在模式切换时清晰变化

### 7.5 陷阱：剪贴板权限被拒绝

**问题**：某些浏览器或安全策略可能阻止 `navigator.clipboard.writeText`。

**规避**：
- 主策略：使用 `navigator.clipboard.writeText()`（需要页面焦点）
- 降级策略：使用 `document.execCommand('copy')`（旧方法，兼容性更好）
- 最终降级：弹出一个文本框（textarea），内容已选中，提示用户手动 `Cmd+C`
- 失败信息明确告知原因和解决方式

### 7.6 陷阱：批量模式下选中数量过多

**问题**：用户选中 50+ 个会话，合并后的 Bundle 可能过大。

**规避**：
- 当选中超过 20 个会话时，浮动栏显示提示："选中了 25 个会话（~150K tokens），部分 AI 工具可能无法处理这么长的上下文"
- 不限制选择数量（尊重用户决策），只是提供信息辅助判断
- 复制过程中显示逐步进度，让用户知道处理需要更长时间

### 7.7 陷阱：平台页面 SPA 路由切换

**问题**：ChatGPT/Claude 是 SPA（单页应用），路由切换不会触发页面重新加载。

**规避**：
- 使用 MutationObserver 监听 DOM 变化和 URL 变化
- 路由切换时（如从会话列表到会话详情），自动重新评估注入点
- 维护一个注入状态管理器，避免重复注入

### 7.8 陷阱：与其他扩展冲突

**问题**：用户可能同时安装了 Echoes、ChatClip 等类似扩展，DOM 注入可能冲突。

**规避**：
- CtxPort 的所有注入元素使用带命名空间的 class（`ctxport-*`）和 id（`ctxport-*`）
- 注入前检查目标位置是否已有 CtxPort 元素（幂等性）
- 使用 Shadow DOM 隔离 CtxPort 的样式，避免被其他扩展或平台的 CSS 影响
- 不修改或删除原生 DOM 元素，只在旁边注入新元素

---

## 8. Accessibility 考虑

### 8.1 键盘可达性

- 所有 CtxPort 注入的按钮和 checkbox 都可通过 Tab 键聚焦
- 聚焦时显示明确的 focus ring（使用平台的 focus 样式）
- Enter/Space 触发按钮点击
- 多选模式下的列表项可通过方向键导航

### 8.2 屏幕阅读器

- 复制按钮的 `aria-label`："Copy conversation as Context Bundle with CtxPort"
- 状态变化时使用 `aria-live="polite"` 通知："Copied 24 messages to clipboard"
- 多选模式的 checkbox 使用正确的 `role="checkbox"` 和 `aria-checked`

### 8.3 视觉对比度

- 所有文本和图标满足 WCAG 2.1 AA 标准的 4.5:1 对比度
- 成功/失败状态不仅用颜色区分，还用不同的图标（✓ vs ⚠）

---

*本文档由 Alan Cooper Goal-Directed Design 方法论驱动，以 Alex（The Multi-Tool Developer）为 Primary Persona，围绕"3 秒内完成一次复制"的核心体验目标设计。所有交互决策均可溯源至 Persona 的目标层次分析。*
